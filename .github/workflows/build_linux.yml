name: Build (Linux)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4

    - name: üõ†Ô∏è Install build dependencies sed
      run: |
        sudo apt update
        sudo apt install -y build-essential

    - name: üîß Run gcc
      run: |
        gcc ./dropsonde/rd41drop.c -lm -o ./dropsonde/rd41drop
        gcc ./dropsonde/rd94drop.c -lm -o ./dropsonde/rd94drop
        gcc ./c34/c34dft.c -lm -o ./c34/c34dft
        gcc ./c34/c50dft.c -lm -o ./c34/c50dft
        gcc ./dfm/dfm06.c -lm -o ./dfm/dfm06
        gcc ./dfm/dfm06ptu.c -lm -o ./dfm/dfm06ptu
        cp ./ecc/bch_ecc.c ./lms6/
        gcc ./lms6/lms6.c -lm -o ./lms6/lms6
        gcc ./lms6/lms6ccsds.c -lm -o ./lms6/lms6ccsds
        gcc ./lms6/lms6ecc.c -lm -o ./lms6/lms6ecc
        gcc ./m10/m10ptu.c -lm -o ./m10/m10ptu
        cp ./ecc/bch_ecc.c ./meisei/
        gcc ./meisei/meisei_ecc.c -lm -o ./meisei/meisei_ecc
        gcc ./meisei/meisei_ims.c -lm -o ./meisei/meisei_ims
        gcc ./meisei/meisei_rs.c -lm -o ./meisei/meisei_rs
        gcc ./mk2a/mk2a.c -lm -o ./mk2a/mk2a
        gcc ./mk2a/mk2a1680mod.c -lm -o ./mk2a/mk2a1680mod
        gcc ./mrz/mp3h1.c -lm -o ./mrz/mp3h1
        cp ./ecc/bch_ecc.c ./rs41/
        gcc ./rs41/rs41.c -lm -o ./rs41/rs41
        gcc ./rs41/rs41ecc.c -lm -o ./rs41/rs41ecc
        gcc ./rs41/rs41iq.c -lm -o ./rs41/rs41iq
        gcc ./rs41/rs41ptu.c -lm -o ./rs41/rs41ptu
        gcc ./rs41/rs41sg.c -lm -o ./rs41/rs41sg
        cp ./ecc/bch_ecc.c ./rs92/
        gcc ./rs92/rs92agp.c -lm -o ./rs92/rs92agp
        gcc ./rs92/rs92agp_ecc.c -lm -o ./rs92/rs92agp_ecc
        gcc ./rs92/rs92ecc.c -lm -o ./rs92/rs92ecc
        gcc ./rs92/rs92gps.c -lm -o ./rs92/rs92gps
        gcc ./weathex/weathex301d.c -lm -o ./weathex/weathex301d
        sed -i 's/^[[:space:]]*char weekday\[7\]\[4\]/extern char weekday[7][4]/' ./rs_module/rs_datum.h
        gcc -c ./rs_module/rs_datum.c -o ./rs_module/rs_datum.o
        gcc -c ./rs_module/rs_demod.c -o ./rs_module/rs_demod.o
        gcc -c ./rs_module/rs_bch_ecc.c -o ./rs_module/rs_bch_ecc.o
        gcc -c ./rs_module/rs_rs41.c -o ./rs_module/rs_rs41.o
        gcc -c ./rs_module/rs_rs92.c -o ./rs_module/rs_rs92.o
        gcc -c ./rs_module/rs_main41.c -o ./rs_module/rs_main41.o
        gcc ./rs_module/rs_main41.o \
            ./rs_module/rs_rs41.o \
            ./rs_module/rs_bch_ecc.o \
            ./rs_module/rs_demod.o \
            ./rs_module/rs_datum.o \
            -lm -o ./rs_module/rs41mod
        gcc -c ./rs_module/rs_main92.c -o ./rs_module/rs_main92.o
        gcc ./rs_module/rs_main92.o \
            ./rs_module/rs_rs92.o \
            ./rs_module/rs_bch_ecc.o \
            ./rs_module/rs_demod.o \
            ./rs_module/rs_datum.o \
            -lm -o ./rs_module/rs92mod
        gcc ./scan/dft_detect.c -lm -o ./scan/dft_detect
        gcc ./scan/reset_usb.c -lm -o ./scan/reset_usb
        gcc ./scan/rs_detect.c -lm -o ./scan/rs_detect
        gcc ./scan/scan_fft_pow.c -lm -o ./scan/scan_fft_pow
        gcc ./scan/scan_fft_simple.c -lm -o ./scan/scan_fft_simple

        
    - name: üì¶ Archive compiled binaries
      uses: actions/upload-artifact@v4
      with:
        name: linux-binaries
        path: |
          ./dropsonde/rd41drop
          ./dropsonde/rd94drop
          ./c34/c34dft
          ./c34/c50dft
          ./dfm/dfm06
          ./dfm/dfm06ptu
          ./lms6/lms6
          ./lms6/lms6ccsds
          ./lms6/lms6ecc
          ./m10/m10ptu
          ./meisei/meisei_ecc
          ./meisei/meisei_ims
          ./meisei/meisei_rs
          ./mk2a/mk2a
          ./mk2a/mk2a1680mod
          ./mrz/mp3h1
          ./rs41/rs41
          ./rs41/rs41ecc
          ./rs41/rs41iq
          ./rs41/rs41ptu
          ./rs41/rs41sg
          ./rs92/rs92agp
          ./rs92/rs92agp_ecc
          ./rs92/rs92ecc
          ./rs92/rs92gps
          ./weathex/weathex301d
          ./rs_module/rs42mod
          ./rs_module/rs92mod
          ./scan/dft_detect
          ./scan/reset_usb
          ./scan/rs_detect
          ./scan/scan_fft_pow
          ./scan/scan_fft_simple
