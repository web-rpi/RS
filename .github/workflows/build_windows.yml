name: Build (Windows)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4

    - name: 🛠️ Install MSYS2 and build tools
      uses: msys2/setup-msys2@v2
      with:
        update: true
        install: >-
          base-devel
          gcc
          make
          sed

    - name: 🔧 Run gcc (MSYS2)
      shell: msys2 {0}
      run: |
        # Vaisala Dropsonde #
        gcc ./dropsonde/rd41drop.c -lm -o ./dropsonde/rd41drop.exe
        gcc ./dropsonde/rd94drop.c -lm -o ./dropsonde/rd94drop.exe

        # Meteolabor SRS-C3450 #
        gcc ./c34/c34dft.c -lm -o ./c34/c34dft.exe
        gcc ./c34/c50dft.c -lm -o ./c34/c50dft.exe

        # Graw DFM06/09/17 #
        gcc ./dfm/dfm06.c -lm -o ./dfm/dfm06.exe
        gcc ./dfm/dfm06ptu.c -lm -o ./dfm/dfm06ptu.exe

        # Lockheed Martin LMS-6 #
        cp ./ecc/bch_ecc.c ./lms6/
        gcc ./lms6/lms6.c -lm -o ./lms6/lms6.exe
        gcc ./lms6/lms6ccsds.c -lm -o ./lms6/lms6ccsds.exe
        gcc ./lms6/lms6ecc.c -lm -o ./lms6/lms6ecc.exe
        gcc ./lms6/lmsX2446.c -lm -o ./lms6/lmsX2446.exe

        # Meteomodem M10/20 #
        gcc ./m10/m10ptu.c -lm -o ./m10/m10ptu.exe
        gcc ./m10/m10gtop.c -lm -o ./m10/m10gtop.exe
        gcc ./m10/m1x12_20160704.c -lm -o ./m10/m1x12_20160704.exe
        gcc ./m10/mXX_20180919.c -lm -o ./m10/mXX_20180919.exe
        gcc ./m10/m10ury20160721.c -lm -o ./m10/m10ury20160721.exe
        gcc ./m10/m10x.c -lm -o ./m10/m10x.exe

        # Meisei #
        cp ./ecc/bch_ecc.c ./meisei/
        gcc ./meisei/meisei_ecc.c -lm -o ./meisei/meisei_ecc.exe
        gcc ./meisei/meisei_ims.c -lm -o ./meisei/meisei_ims.exe
        gcc ./meisei/meisei_rs.c -lm -o ./meisei/meisei_rs.exe

        # MK2A #
        gcc ./mk2a/mk2a.c -lm -o ./mk2a/mk2a.exe
        gcc ./mk2a/mk2a1680mod.c -lm -o ./mk2a/mk2a1680mod.exe
        gcc ./mk2a/mk2a_lms1680.c -lm -o ./mk2a/mk2a_lms1680.exe

        # MRZ MP3-H1 #
        gcc ./mrz/mp3h1.c -lm -o ./mrz/mp3h1.exe

        # Vaisala RS41 #
        cp ./ecc/bch_ecc.c ./rs41/
        gcc ./rs41/rs41.c -lm -o ./rs41/rs41.exe
        gcc ./rs41/rs41ecc.c -lm -o ./rs41/rs41ecc.exe
        gcc ./rs41/rs41iq.c -lm -o ./rs41/rs41iq.exe
        gcc ./rs41/rs41ptu.c -lm -o ./rs41/rs41ptu.exe
        gcc ./rs41/rs41sg.c -lm -o ./rs41/rs41sg.exe

        # Vaisala RS92 #
        cp ./ecc/bch_ecc.c ./rs92/
        gcc ./rs92/gps_navdata.c -lm -o ./rs92/gps_navdata.exe
        gcc ./rs92/rs92agp.c -lm -o ./rs92/rs92agp.exe
        gcc ./rs92/rs92agp_ecc.c -lm -o ./rs92/rs92agp_ecc.exe
        gcc ./rs92/rs92ecc.c -lm -o ./rs92/rs92ecc.exe
        gcc ./rs92/rs92gps.c -lm -o ./rs92/rs92gps.exe
        gcc ./rs92/rs92gps_2dfix.c -lm -o ./rs92/rs92gps_2dfix.exe

        # Weathex 301D #
        gcc ./weathex/weathex301d.c -lm -o ./weathex/weathex301d.exe
        gcc ./weathex/weathex_20230512_401100kHz.c -lm -o ./weathex/weathex_20230512_401100kHz.exe

        # IQ #
        gcc ./iq/shift_IQ.c -lm -o ./iq/shift_IQ.exe
        gcc ./iq/wavIQ.c -lm -o ./iq/wavIQ.exe

        # RS Module #
        sed -i 's/^[[:space:]]*char weekday\[7\]\[4\]/extern char weekday[7][4]/' ./rs_module/rs_datum.h
        gcc -c ./rs_module/rs_datum.c -o ./rs_module/rs_datum.o
        gcc -c ./rs_module/rs_demod.c -o ./rs_module/rs_demod.o
        gcc -c ./rs_module/rs_bch_ecc.c -o ./rs_module/rs_bch_ecc.o
        gcc -c ./rs_module/rs_rs41.c -o ./rs_module/rs_rs41.o
        gcc -c ./rs_module/rs_rs92.c -o ./rs_module/rs_rs92.o
        gcc -c ./rs_module/rs_main41.c -o ./rs_module/rs_main41.o
        gcc ./rs_module/rs_main41.o \
            ./rs_module/rs_rs41.o \
            ./rs_module/rs_bch_ecc.o \
            ./rs_module/rs_demod.o \
            ./rs_module/rs_datum.o \
            -lm -o ./rs_module/rs41mod.exe
        gcc -c ./rs_module/rs_main92.c -o ./rs_module/rs_main92.o
        gcc ./rs_module/rs_main92.o \
            ./rs_module/rs_rs92.o \
            ./rs_module/rs_bch_ecc.o \
            ./rs_module/rs_demod.o \
            ./rs_module/rs_datum.o \
            -lm -o ./rs_module/rs92mod.exe

        # Scan #
        gcc ./scan/dft_detect.c -lm -o ./scan/dft_detect.exe
        # gcc ./scan/reset_usb.c -lm -o ./scan/reset_usb.exe # ToDo ... it's possible with win host? i dont think so ...
        gcc ./scan/rs_detect.c -lm -o ./scan/rs_detect.exe
        gcc ./scan/scan_fft_pow.c -lm -o ./scan/scan_fft_pow.exe
        gcc ./scan/scan_fft_simple.c -lm -o ./scan/scan_fft_simple.exe

    - name: 📦 Archive compiled binaries
      uses: actions/upload-artifact@v4
      with:
        name: windows-binaries
        path: |
          ./**/*.exe
